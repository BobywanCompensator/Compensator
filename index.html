<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Carte Galactique – Campagne COMPENSATOR</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
body{
  margin:0;
  font-family:'Share Tech Mono',monospace;
  background:#02030a;
  color:#cfe7d8;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
h1,h2{
  font-size:14px;
  margin:14px 0 6px;
  text-transform:uppercase;
  letter-spacing:3px;
  color:#00FF66;
  text-shadow:0 0 6px rgba(120,255,220,.9),0 0 12px rgba(120,255,220,.6),0 0 18px rgba(120,255,220,.3);
}
#title-bar{
  height:50px;
  width:100%;
  flex-shrink:0;
  background-image:url('https://i.imgur.com/vQkK685.png');
  background-size:contain;
  background-position:center;
  background-repeat:no-repeat;
}
#title-bar img{
  height:100%;
  width:auto;
  object-fit:contain;
  display:block;
}
.layout{
  display:grid;
  grid-template-columns: 1fr 460px;
  height: calc(100vh - 50px);
}
#map-container{position:relative;overflow:hidden}
#map-bg{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:contain;pointer-events:none;z-index:1
}
#galaxy{
  position:relative;z-index:3;width:100%;height:100%;
  transform:scale(0.9);transform-origin:center
}
svg{width:100%;height:100%}
.sector{
  stroke:#9fffd0;
  stroke-width:2;
  fill-opacity:.35;
  cursor:pointer;
  filter:drop-shadow(0 0 6px rgba(120,255,220,.4));
}
.sector.old{
  fill-opacity:.18;
  stroke-dasharray:4 4;
  filter:none;
}
.sector.contested{
  stroke-width:3;
  filter:drop-shadow(0 0 12px rgba(255,120,120,.9));
}
.sector:hover{fill-opacity:.6;stroke:#fff}
.sector.Imperium{fill:#2a4fff;} /* bleu impérial */
.sector.Chaos{fill:#b02020;}    /* rouge chaos */
.sector.Xenos{fill:#2a8f55;}    /* vert xenos */
.sector.Neutral{fill:#555}
.sector.battle-hot{animation:pulse 1.5s infinite}
@keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
.sector-label{
  fill:#eafff6;
  font-size:14px; /* plus grand */
  font-weight:bold;
  text-anchor:middle;
  dominant-baseline:middle;
  pointer-events:none;
  paint-order:stroke;
  stroke:#000;
  stroke-width:2px;
  stroke-opacity:0.6;
}
.sector-label tspan{dominant-baseline:middle;}
.sector-label tspan{dominant-baseline:middle;}
.sector-count{
  fill:#00FF66;
  font-size:12px;
  text-anchor:middle;
  pointer-events:none;
}
.journal-panel{
  background:#021010;
  border-left:2px solid #1c3b2f;
  padding:12px;
  display:flex;
  flex-direction:column;
  overflow-y:scroll; /* scrollbar toujours présent pour éviter les sauts */
}
.right-top{
  height:180px;
  flex:none;
  overflow:auto;
  background-image:url('https://i.imgur.com/wXy4Uu5.png');
  background-size:100% 100%;
  background-position:center;
  background-repeat:no-repeat;
  padding:22px 18px 16px 18px; /* zone texte calée dans l'écran */
  box-sizing:border-box;
}

.right-mid{
  height:180px;
  flex:none;
  overflow:auto;
  background-image:url('https://i.imgur.com/fJxgv20.png');
  background-size:100% 100%;
  background-position:center;
  background-repeat:no-repeat;
  position:relative;
  padding:22px 18px 16px 18px; /* zone texte calée dans l'écran */
  box-sizing:border-box;
}

.right-mid::before{
  content:'';
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.25); /* assure la lisibilité */
  pointer-events:none;
}

.right-bottom{
  flex:1;
  overflow-y:auto;
  background-image:url('https://i.imgur.com/sqnKcHd.png');
  background-size:100% 100%;
  background-position:center;
  background-repeat:no-repeat;
  position:relative;
  padding:26px 20px 20px 20px; /* journal plus respirant */
  box-sizing:border-box;
}

.journal-entry{
  border-bottom:1px dashed #1c3b2f;
  padding:6px 0;
  font-size:12px;
  color:#00FF66;
  text-shadow:0 0 3px rgba(120,255,200,.7),0 0 6px rgba(120,255,200,.4);
}
.bar{height:8px;background:#122;margin-bottom:6px;position:relative}
.bar>div{height:100%}
select,button{background:#020b0b;color:#b7fff2;border:1px solid #1c3b2f;font-family:inherit;font-size:12px;margin:2px 0}
button{cursor:pointer;padding:4px 8px}
button:hover{background:#0a2a2a}
body::after{content:'';position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(0deg,rgba(255,255,255,.015),rgba(0,0,0,.02) 2px,rgba(0,0,0,.04) 4px);mix-blend-mode:overlay}
</style>
</head>

<body>
<div id="title-bar"></div>

<div class="layout">
<div id="map-container">
<img id="map-bg" src="https://i.imgur.com/KwrORx4.png" alt="">
<svg id="galaxy" viewBox="-520 -520 1040 1040"></svg>
</div>

<div class="journal-panel">
  <div class="right-top">
    <h2>Contrôle Galactique</h2>
    <div id="factionBars"></div>
  </div>
  <div class="right-mid">
    <h2>Classement des Seigneurs</h2>
    <div id="warlordStats"></div>
  </div>
  <div class="right-bottom">
    <h2>Journal</h2>
    <div id="journal"></div>
  </div>
</div>
</div>

<script>
/* ===== UTILITAIRES ===== */
const rad=a=>a*Math.PI/180;
const polar=(r,a)=>({x:r*Math.cos(rad(a)),y:r*Math.sin(rad(a))});
const pick=a=>a[Math.floor(Math.random()*a.length)];
const factions=['Imperium','Chaos','Xenos'];
let battleOpen=false; // verrou interaction carte

/* ===== WARLORDS ===== */
const warlords=['Inconnu','Jo El-Johnson','Dacapala','Le Putride Grognon','Qui pour un TTS ce matin?'];
const warlordStats={};
warlords.forEach(w=>warlordStats[w]={win:0,loss:0});

function validWarlords(a,d){
  if(a==='Inconnu'||d==='Inconnu') return true;
  return a!==d;
}

function renderWarlords(){
  const ws=document.getElementById('warlordStats');
  ws.innerHTML='';
  Object.entries(warlordStats)
    .filter(([n])=>n!=='Inconnu')
    .sort((a,b)=>b[1].win-a[1].win)
    .forEach(([n,s])=>{
      const d=document.createElement('div');
      d.textContent=`${n} – V:${s.win} / D:${s.loss}`;
      ws.appendChild(d);
    });
}

/* ===== NARRATION ===== */
const introA=[
  'Les augures annoncent que',
  'Sous un ciel déchiré par le Warp,',
  'Les chroniques impériales rapportent que',
  'Les archives interdites mentionnent que',
  'Dans le fracas des canons stellaires,',
  'Alors que le Voile se déchirait,',
  'Au terme d’omens sanglants,',
  'Les vox antiques crépitent :',
  'Les scribes du Mechanicus consignent que',
  'Dans une tempête de feu et de prières,'
];

const introB=[
  'les forces menées par',
  'les cohortes commandées par',
  'les légions placées sous l’autorité de',
  'les armées rassemblées derrière',
  'les guerriers fanatisés de',
  'les osts belliqueux dirigés par',
  'les détachements d’élite guidés par'
];

const introC=[
  'se sont heurtées à',
  'ont engagé le combat contre',
  'ont croisé le fer avec',
  'ont lancé l’assaut sur',
  'ont défié sans pitié',
  'ont affronté dans un carnage total'
];

const battleNames=[
  'la Boucherie de',
  'le Massacre de',
  'la Purge de',
  'le Siège de',
  'l’Anéantissement de',
  'la Dévastation de',
  'le Cataclysme de',
  'la Profanation de',
  'la Guerre de',
  'la Chute de'
];

const resultAtkWin=[
  'Au terme d’un assaut implacable, {faction} triomphe et s’empare du secteur.',
  '{faction} noie la zone sous le feu et revendique le contrôle total.',
  'La résistance s’effondre : {faction} plante ses étendards victorieux.',
  'Les défenseurs sont balayés. {faction} règne désormais sur ces étoiles.',
  'Par le sang et l’acier, {faction} conquiert ce territoire.'
];

const resultDefWin=[
  'Malgré les pertes, {faction} tient la ligne et conserve le secteur.',
  'Les assauts sont brisés : {faction} demeure maître des lieux.',
  'La défense tient bon. {faction} repousse l’ennemi.',
  'Les envahisseurs sont anéantis. {faction} conserve le contrôle.',
  'Le secteur reste inviolé sous la férule de {faction}.'
];

function narrate(sector,atkW,defW,atkFaction,defFaction,atkWin){
  const title=`${pick(battleNames)} ${sector.name}`;
  const intro=`${pick(introA)} ${pick(introB)} ${atkW} ${pick(introC)} ${defW}.`;
  const result=atkWin
    ? pick(resultAtkWin).replace('{faction}',atkFaction)
    : pick(resultDefWin).replace('{faction}',defFaction);
  return [`[${title}]`,intro,result];
}

/* ===== GEOMETRIE ===== */
function sectorPath(r1,r2,a1,a2){
  const p1=polar(r2,a1),p2=polar(r2,a2),p3=polar(r1,a2),p4=polar(r1,a1);
  return `M ${p1.x} ${p1.y} A ${r2} ${r2} 0 0 1 ${p2.x} ${p2.y}
          L ${p3.x} ${p3.y} A ${r1} ${r1} 0 0 0 ${p4.x} ${p4.y} Z`;
}

/* ===== DONNÉES ===== */
const sectorNames=[
'ANUS ASTRALIS','LOSER PRIME','PAR KING','GOT CHA FISDEPUS',
'REROLL SANCTUM','WYS IWYG I','SPHINCTER PRIME','ORIFICIUS SACRALIS',
'CHAR ZADOUZ','EJACTUS PRECOR','PRE PHUS TRANCHIS','SILLON KIPUS',
'CHATUS COCUS','DACAPREPUS','DEFAITIS CONTESTATUS','MALA LANUS',
'SALIS ETERNUM','RELIQUA POSTERIOR','TESSUR?','ULTIMA FISSURA'
];

const SCALE=0.85;
const sectors=[{
  name:'TROU SALÉ DE LA CHOUINE ÉTERNELLE',
  owner:'Neutral',immutable:true,isCenter:true,
  r:90*SCALE,battles:0
}];

function makeRing(r1,r2,count){
  r1*=SCALE; r2*=SCALE;
  let w=[],t=0;
  for(let i=0;i<count;i++){let v=1+(Math.random()-.5)*.3;w.push(v);t+=v;}
  let a=Math.random()*360;
  for(let i=0;i<count;i++){
    let s=360*(w[i]/t);
    sectors.push({
      name:sectorNames[sectors.length%sectorNames.length],
      owner:factions[i%3],
      r1,r2,a1:a,a2:a+s,
      battles:0
    });
    a+=s;
  }
}
makeRing(90,190,3);
makeRing(190,320,6);
makeRing(320,500,9);

/* ===== RENDU ===== */
function render(){
  const svg=document.getElementById('galaxy');
  svg.innerHTML='';

  sectors.forEach(s=>{
    if(s.isCenter){
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r',s.r);
      c.setAttribute('class','sector '+s.owner);
      svg.appendChild(c);

      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',0);
      t.setAttribute('y',0);
      t.setAttribute('class','sector-label');
      const words=s.name.split(' ');
      if(words.length>2){
        const mid=Math.ceil(words.length/2);
        const lines=[words.slice(0,mid).join(' '),words.slice(mid).join(' ')];
        lines.forEach((l,i)=>{
          const sp=document.createElementNS('http://www.w3.org/2000/svg','tspan');
          sp.setAttribute('x',0);
          sp.setAttribute('dy',i===0?'-0.3em':'1.2em');
          sp.textContent=l;
          t.appendChild(sp);
        });
      }else{
        t.textContent=s.name;
      }
      svg.appendChild(t);
      return;
    }

    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',sectorPath(s.r1,s.r2,s.a1,s.a2));
    p.setAttribute('class','sector '+s.owner+(s.battles>4?' battle-hot':''));
    p.onclick=()=>{
      if(battleOpen) return;
      openBattleConsole(s);
    };
    svg.appendChild(p);

    const midA=(s.a1+s.a2)/2;
    const midR=(s.r1+s.r2)/2;
    const pos=polar(midR,midA);

    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',pos.x);
    t.setAttribute('y',pos.y);
    t.setAttribute('class','sector-label');

    const words=s.name.split(' ');
    if(words.length>2){
      const mid=Math.ceil(words.length/2);
      const lines=[words.slice(0,mid).join(' '),words.slice(mid).join(' ')];
      lines.forEach((l,i)=>{
        const sp=document.createElementNS('http://www.w3.org/2000/svg','tspan');
        sp.setAttribute('x',pos.x);
        sp.setAttribute('dy',i===0?'-0.3em':'1.2em');
        sp.textContent=l;
        t.appendChild(sp);
      });
    }else{
      t.textContent=s.name;
    }
    svg.appendChild(t);

    if(s.battles>0){
      const cpt=document.createElementNS('http://www.w3.org/2000/svg','text');
      cpt.setAttribute('x',pos.x);
      cpt.setAttribute('y',pos.y+14);
      cpt.setAttribute('class','sector-count');
      cpt.textContent=`⚔ ${s.battles}`;
      svg.appendChild(cpt);
    }
  });

  updateFactionBars();
}

/* ===== BARRES ===== */
function updateFactionBars(){
  const fb=document.getElementById('factionBars');
  fb.innerHTML='';
  const total=sectors.filter(s=>!s.isCenter).length;
  factions.forEach(f=>{
    const own=sectors.filter(s=>s.owner===f).length;
    const bar=document.createElement('div');
    bar.className='bar';
    const fill=document.createElement('div');
    fill.style.width=(own/total*100)+'%';
    // Nuances de vert par faction (style cogitator)
    fill.style.background =
      f === 'Imperium' ? 'linear-gradient(90deg,#00ff66,#66ff99)' :
      f === 'Chaos'    ? 'linear-gradient(90deg,#009944,#00cc55)' :
                         'linear-gradient(90deg,#33ff88,#99ffcc)';
    bar.appendChild(fill);
    fb.append(f,bar);
  });
}

/* ===== CONSOLE ===== */
function openBattleConsole(sector){
  if(battleOpen) return;
  if(sector.immutable) return;
  battleOpen=true;

  const j=document.getElementById('journal');
  const e=document.createElement('div');
  e.className='journal-entry';

  const attackers=factions.filter(f=>f!==sector.owner);

  e.innerHTML=`
  > ENGAGEMENT – ${sector.name}<br>
  Défenseur (${sector.owner})<br>
  <select class="def">${warlords.map(w=>`<option>${w}</option>`).join('')}</select><br>
  Attaquant<br>
  <select class="atkF">${attackers.map(f=>`<option>${f}</option>`).join('')}</select>
  <select class="atk">${warlords.map(w=>`<option>${w}</option>`).join('')}</select><br>
  <button class="awin">Victoire Attaquant</button>
  <button class="dwin">Victoire Défenseur</button>
  <button class="cancel">Annuler</button>
  `;

  e.querySelector('.awin').onclick=()=>{
    const atk=e.querySelector('.atk').value;
    const def=e.querySelector('.def').value;
    if(!validWarlords(atk,def)) return;

    const atkFaction=e.querySelector('.atkF').value;
    const oldOwner=sector.owner;

    sector.owner=atkFaction;
    sector.battles++;
    warlordStats[atk].win++;
    warlordStats[def].loss++;

    const lines=narrate(sector,atk,def,atkFaction,oldOwner,true);
    const entry=document.createElement('div');
    entry.className='journal-entry';
    entry.innerHTML=`<div>${lines[0]}</div><div>${lines[1]}</div><div>${lines[2]}</div>`;
    j.prepend(entry);

    e.remove();
    battleOpen=false;
    render();
    renderWarlords();
  };

  e.querySelector('.dwin').onclick=()=>{
    const atk=e.querySelector('.atk').value;
    const def=e.querySelector('.def').value;
    if(!validWarlords(atk,def)) return;

    const oldOwner=sector.owner;

    sector.battles++;
    warlordStats[atk].loss++;
    warlordStats[def].win++;

    const lines=narrate(sector,atk,def,'',oldOwner,false);
    const entry=document.createElement('div');
    entry.className='journal-entry';
    entry.innerHTML=`<div>${lines[0]}</div><div>${lines[1]}</div><div>${lines[2]}</div>`;
    j.prepend(entry);

    e.remove();
    battleOpen=false;
    render();
    renderWarlords();
  };

  e.querySelector('.cancel').onclick=()=>{
    e.remove();
    battleOpen=false;
  };

  j.prepend(e);
}

render();
renderWarlords();
</script>
</body>
</html>
